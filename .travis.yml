# Travis CI config for Snorkel, a training data creation and management
# system focused on information extraction

dist: trusty
sudo: false  # to use container-based infra, see: http://docs.travis-ci.com/user/migrating-from-legacy/

language:
  - python
python:
  - "2.7"
jdk:
  - oraclejdk8

cache:
  directories:
    - $HOME/.cache/pip
    - parser                         # to avoid repetitively downloading CoreNLP

addons:
  apt:
    packages:
    # CoreNLP needs Java 8
    - oracle-java8-installer
    - python-tk

# Following trick is necessary to get a binary distribution of numpy, scipy, etc. which takes too long to build every time
# See: http://stackoverflow.com/q/30588634
# See: https://github.com/Theano/Theano/blob/master/.travis.yml (for caching)
# See: http://conda.pydata.org/docs/travis.html
before_install:
  # Make sure Java 8 is used
  - export PATH="/usr/lib/jvm/java-8-oracle/bin:$PATH"
  - export JAVA_HOME=/usr/lib/jvm/java-8-oracle
  - java -version

  # Set environment variables
  - source set_env.sh

install:
  # Install binary distribution of scientific python modules
  - pip install numpy scipy matplotlib

  # Install Numba
  - pip install numba

  # Install all remaining dependencies as per our README
  - pip install -r python-package-requirement.txt
  - test -e parser/corenlp.sh || ./install-parser.sh

  # Use runipy to run Jupyter/IPython notebooks from command-line
  - pip install runipy

script:

  # Run test modules
  - python test/learning/test_gen_learning.py
  - python test/learning/test_supervised.py
  - python test/learning/test_categorical.py
  - runipy test/learning/test_TF_notebook.ipynb
  - runipy test/learning/test_parallel_grid_search.ipynb

  # Runs intro tutorial notebooks
  - cd tutorials
  - runipy intro/Intro_Tutorial_1.ipynb
  - runipy intro/Intro_Tutorial_2.ipynb
  - runipy intro/Intro_Tutorial_3.ipynb

  # Run advanced notebooks
  - runipy advanced/Categorical_Classes.ipynb
  - runipy advanced/Structure_Learning.ipynb

  # Run CDR tutorials
  - runipy cdr/CDR_Tutorial_1.ipynb
  - runipy cdr/CDR_Tutorial_2.ipynb
  - runipy cdr/CDR_Tutorial_3.ipynb

  - runipy snark/Snark_Tutorial.ipynb

  # TODO check outputs, upload results, etc.
  # for more ideas, see: https://github.com/rossant/ipycache/issues/7

after_success:
  - killall java

after_failure:
  - killall java
